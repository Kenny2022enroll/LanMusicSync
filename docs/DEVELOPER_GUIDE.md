# LAN Music Sync 开发者指南

## 目录

1. [项目概述](#项目概述)
2. [架构设计](#架构设计)
3. [开发环境设置](#开发环境设置)
4. [核心组件详解](#核心组件详解)
5. [网络通信协议](#网络通信协议)
6. [音频处理流程](#音频处理流程)
7. [测试指南](#测试指南)
8. [部署和发布](#部署和发布)
9. [贡献指南](#贡献指南)

## 项目概述

### 技术栈

LAN Music Sync 是一个基于 Android 平台的音乐同步播放应用，采用现代化的 Android 开发技术栈构建。项目使用 Kotlin 作为主要开发语言，充分利用了 Kotlin 的简洁性和安全性特性。

**核心技术组件**

应用基于 Android Jetpack 组件构建，采用 MVVM（Model-View-ViewModel）架构模式。这种架构模式提供了清晰的关注点分离，使代码更易于维护和测试。

ExoPlayer 作为音频播放引擎，提供了强大的媒体播放能力和精确的播放控制。ExoPlayer 是 Google 开发的开源媒体播放器，专门为 Android 平台优化，支持多种音频格式和流媒体协议。

网络通信基于 Socket 和 Wi-Fi Direct 技术实现。Wi-Fi Direct 允许设备间建立直接的点对点连接，无需传统的 Wi-Fi 接入点，这为音乐同步提供了低延迟、高带宽的通信基础。

**设计原则**

项目遵循 Android 开发最佳实践，包括 Material Design 设计规范、响应式布局设计、生命周期感知组件等。代码结构清晰，模块化程度高，便于扩展和维护。

安全性是项目的重要考虑因素。所有网络通信都经过适当的验证和错误处理，确保应用在各种网络环境下都能稳定运行。

性能优化贯穿整个开发过程，从网络通信的异步处理到音频数据的高效传输，都经过精心设计以提供最佳的用户体验。

### 功能架构

**主从设备模式**

应用采用主从设备架构，其中一台设备作为主设备（Host），负责音乐播放控制和设备管理，其他设备作为从设备（Client），接收并同步播放主设备的音频内容。

主设备承担以下职责：音乐文件的读取和解码、播放控制逻辑的处理、音频数据的编码和分发、从设备连接的管理、播放状态的同步广播。

从设备的主要功能包括：主设备的发现和连接、音频数据的接收和解码、播放状态的同步、本地播放的精确控制。

**同步机制**

音频同步是应用的核心技术挑战。系统实现了多层次的同步机制，包括时钟同步、数据同步和播放同步。

时钟同步确保所有设备使用统一的时间基准。主设备定期向从设备发送时间同步信息，从设备根据网络延迟调整本地时钟。

数据同步负责音频数据的可靠传输。系统使用缓冲机制和重传机制确保音频数据的完整性和及时性。

播放同步通过精确的时间戳控制实现。每个音频数据包都包含播放时间戳，从设备根据时间戳精确控制播放时机。


## 架构设计

### MVVM 架构模式

**Model 层**

Model 层包含应用的数据模型和业务逻辑。主要组件包括数据实体类、网络通信管理器、音频处理器等。

数据模型定义了应用中使用的核心数据结构，如 `MusicTrack`、`Device`、`PlaybackState` 等。这些模型类使用 Kotlin 的 data class 特性，提供了简洁的数据封装和自动生成的 equals、hashCode 等方法。

网络通信管理器负责设备间的通信协议实现，包括设备发现、连接建立、数据传输等功能。这些组件采用协程（Coroutines）进行异步处理，确保网络操作不会阻塞主线程。

音频处理器封装了 ExoPlayer 的复杂性，提供简化的音频播放接口。它处理音频文件的加载、解码、播放控制等操作，并提供播放状态的回调机制。

**View 层**

View 层包含所有的 UI 组件，主要是 Activity 和 Fragment。这些组件负责用户界面的展示和用户交互的处理。

MainActivity 是应用的入口点，提供模式选择和基本的设备管理功能。它使用 Material Design 组件构建现代化的用户界面，支持深色模式和动态主题。

HostActivity 和 ClientActivity 分别处理主设备和从设备的特定功能。它们通过 Data Binding 和 View Binding 技术与布局文件绑定，减少了样板代码并提高了类型安全性。

**ViewModel 层**

ViewModel 层连接 View 和 Model，管理 UI 相关的数据和状态。ViewModel 具有生命周期感知能力，能够在配置变更（如屏幕旋转）时保持数据。

MainViewModel 管理主界面的状态，包括网络连接状态、权限状态、设备发现状态等。它使用 LiveData 向 View 层提供响应式的数据更新。

MusicSyncViewModel 是核心的 ViewModel，管理音乐播放和设备同步的所有状态。它与 MusicSyncService 通信，将服务层的数据转换为 UI 可用的格式。

### 服务架构

**MusicSyncService**

MusicSyncService 是应用的核心服务，运行在前台以确保音乐播放和设备同步的连续性。它集成了音频播放、网络通信、设备管理等多个功能模块。

服务采用组件化设计，每个功能模块都是独立的组件，通过接口进行通信。这种设计提高了代码的可测试性和可维护性。

服务使用 Kotlin Coroutines 进行并发处理，确保网络操作、音频处理和 UI 更新能够并行进行而不相互阻塞。

**网络服务组件**

SocketManager 负责底层的 Socket 通信，提供可靠的数据传输机制。它支持 TCP 和 UDP 两种协议，根据数据类型选择合适的传输方式。

DeviceDiscovery 实现设备发现功能，结合 Wi-Fi Direct 和网络广播技术，确保快速准确的设备发现。

MessageSerializer 处理网络消息的序列化和反序列化，使用 JSON 格式进行数据交换，确保跨设备的兼容性。

## 开发环境设置

### 系统要求

**开发工具**

Android Studio Arctic Fox (2020.3.1) 或更高版本是推荐的开发环境。Android Studio 提供了完整的 Android 开发工具链，包括代码编辑器、调试器、性能分析工具等。

JDK 17 是项目的 Java 开发工具包要求。虽然项目主要使用 Kotlin，但 Android 开发仍然需要 Java 运行时环境。

Android SDK API 24 (Android 7.0) 是最低支持版本，目标 SDK 版本为 API 34 (Android 14)。这确保了应用能够在广泛的 Android 设备上运行，同时利用最新的 Android 特性。

**版本控制**

项目使用 Git 进行版本控制，建议使用 Git 2.30 或更高版本。项目配置了 .gitignore 文件，排除了构建产物、IDE 配置文件等不需要版本控制的文件。

### 项目设置

**克隆和导入**

首先从 GitHub 克隆项目仓库到本地开发环境。使用以下命令：

```bash
git clone https://github.com/yourusername/LanMusicSync.git
cd LanMusicSync
```

在 Android Studio 中打开项目。IDE 会自动识别这是一个 Android 项目并开始同步 Gradle 文件。

**依赖管理**

项目使用 Gradle 进行依赖管理和构建配置。主要依赖包括：

Android Jetpack 组件提供现代化的 Android 开发基础设施，包括 ViewModel、LiveData、Navigation 等。

ExoPlayer 提供强大的媒体播放能力，支持多种音频格式和流媒体协议。

OkHttp 和 Retrofit 用于网络通信的高级封装，虽然项目主要使用 Socket 进行底层通信，但这些库用于某些辅助功能。

Material Design Components 提供符合 Google 设计规范的 UI 组件。

**构建配置**

项目配置了多个构建变体，包括 debug 和 release。Debug 版本启用了详细的日志记录和调试功能，Release 版本进行了代码混淆和优化。

Gradle 配置文件中定义了代码质量检查工具，包括 Android Lint、Detekt（Kotlin 静态分析）等。这些工具帮助维护代码质量和一致性。

### 开发工作流

**分支策略**

项目采用 Git Flow 分支策略。主要分支包括：

main 分支包含稳定的发布版本代码，所有发布都从这个分支创建标签。

develop 分支是开发主分支，包含最新的开发进度，所有功能分支都合并到这里。

feature/* 分支用于开发新功能，从 develop 分支创建，完成后合并回 develop。

hotfix/* 分支用于紧急修复，从 main 分支创建，修复后同时合并到 main 和 develop。

**代码规范**

项目遵循 Kotlin 官方编码规范和 Android 开发最佳实践。主要规范包括：

使用 4 个空格进行缩进，不使用制表符。

类名使用 PascalCase，函数和变量名使用 camelCase。

常量使用 UPPER_SNAKE_CASE 命名。

每个类和公共函数都应该有适当的文档注释。

**测试策略**

项目采用多层次的测试策略，包括单元测试、集成测试和 UI 测试。

单元测试使用 JUnit 和 Mockito 框架，测试独立的功能模块。

集成测试验证不同组件之间的交互，特别是网络通信和音频处理的集成。

UI 测试使用 Espresso 框架，自动化测试用户界面的功能和交互。

