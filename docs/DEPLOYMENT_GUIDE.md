# LAN Music Sync 部署指南

## 目录

1. [部署概述](#部署概述)
2. [GitHub Actions 配置](#github-actions-配置)
3. [本地构建](#本地构建)
4. [签名配置](#签名配置)
5. [发布流程](#发布流程)
6. [质量保证](#质量保证)
7. [监控和维护](#监控和维护)

## 部署概述

### 自动化部署架构

LAN Music Sync 项目采用现代化的 CI/CD（持续集成/持续部署）流程，基于 GitHub Actions 实现全自动化的构建、测试和发布。这种架构确保了代码质量的一致性，减少了人为错误，并提高了开发效率。

**部署流水线**

整个部署流程分为三个主要阶段：持续集成、质量保证和发布部署。每个阶段都有明确的职责和质量门控，确保只有通过所有检查的代码才能进入下一阶段。

持续集成阶段在每次代码推送时自动触发，执行代码编译、单元测试、静态分析等基础检查。这个阶段的目标是快速发现基本的代码问题，为开发者提供即时反馈。

质量保证阶段进行更深入的代码质量检查，包括安全扫描、性能测试、集成测试等。这个阶段确保代码不仅功能正确，还符合安全和性能标准。

发布部署阶段负责构建最终的 APK 文件，进行签名，并发布到 GitHub Releases。这个阶段只在创建发布标签时触发，确保发布的严肃性和可控性。

**环境管理**

项目配置了多个环境来支持不同的开发和部署需求：

开发环境用于日常开发和测试，配置了详细的日志记录和调试功能。

测试环境用于集成测试和质量保证，模拟生产环境的配置但包含测试辅助功能。

生产环境是最终用户使用的环境，经过完全优化，移除了所有调试功能。

### 版本管理策略

**语义化版本控制**

项目采用语义化版本控制（Semantic Versioning）规范，版本号格式为 MAJOR.MINOR.PATCH：

MAJOR 版本号在进行不兼容的 API 修改时递增。对于移动应用，这通常意味着重大的功能变更或架构调整。

MINOR 版本号在添加向后兼容的新功能时递增。这包括新的用户功能、性能改进等。

PATCH 版本号在进行向后兼容的问题修复时递增。这主要是 bug 修复和小的改进。

**发布周期**

项目采用定期发布和按需发布相结合的策略：

主要版本（MAJOR）每年发布 1-2 次，包含重大功能更新和架构改进。

功能版本（MINOR）每季度发布一次，包含新功能和显著改进。

修复版本（PATCH）根据需要随时发布，主要用于紧急 bug 修复和安全更新。

## GitHub Actions 配置

### 工作流文件结构

项目在 `.github/workflows/` 目录下配置了三个主要的工作流文件，每个文件负责不同的自动化任务：

**android-ci.yml - 持续集成工作流**

这个工作流在每次推送到 main 或 develop 分支时触发，也在创建 Pull Request 时运行。它的主要职责是验证代码的基本质量和功能正确性。

工作流首先设置 Java 17 环境和 Android SDK，然后缓存 Gradle 依赖以加速后续构建。接着运行单元测试、Android Lint 检查，最后构建 debug 和 release APK。

所有构建产物都会上传为 GitHub Artifacts，方便开发者下载和测试。测试报告和 Lint 结果也会作为 Artifacts 保存，便于问题分析。

**android-release.yml - 发布工作流**

发布工作流只在创建版本标签（如 v1.0.0）时触发，或者通过手动触发（workflow_dispatch）执行。这个工作流负责构建正式的发布版本。

工作流支持 APK 签名功能。如果配置了签名密钥，会构建签名的 APK；否则构建未签名的 APK。签名信息通过 GitHub Secrets 安全地存储和传递。

构建完成后，工作流会自动创建 GitHub Release，包含版本说明和 APK 文件。版本说明包括功能更新、技术特性和系统要求等信息。

**code-quality.yml - 代码质量检查工作流**

代码质量工作流专注于深度的代码分析和安全检查。它运行多种静态分析工具，包括 Detekt、Ktlint 和 Trivy 安全扫描。

工作流会生成详细的代码质量报告，并在 Pull Request 中自动添加评论，总结检查结果。这帮助开发者在合并代码前了解潜在的问题。

安全扫描结果会上传到 GitHub Security 标签页，集成到 GitHub 的安全管理功能中。

### 环境变量和密钥管理

**GitHub Secrets 配置**

项目使用 GitHub Secrets 安全地存储敏感信息，包括：

`KEYSTORE_BASE64`: APK 签名密钥库的 Base64 编码，用于发布版本的签名。

`SIGNING_KEY_ALIAS`: 签名密钥的别名。

`SIGNING_KEY_PASSWORD`: 签名密钥的密码。

`SIGNING_STORE_PASSWORD`: 密钥库的密码。

这些密钥只在发布工作流中使用，确保发布的 APK 具有有效的数字签名。

**环境变量管理**

工作流中定义了多个环境变量来控制构建行为：

`JAVA_VERSION`: 指定使用的 Java 版本，当前为 17。

`GRADLE_OPTS`: Gradle 构建选项，包括内存设置和并行构建配置。

`ANDROID_COMPILE_SDK`: 编译使用的 Android SDK 版本。

`ANDROID_TARGET_SDK`: 目标 Android SDK 版本。

## 本地构建

### 开发环境构建

**Debug 构建**

开发过程中主要使用 debug 构建变体，它包含完整的调试信息和日志记录：

```bash
./gradlew assembleDebug
```

Debug 版本会在应用 ID 后添加 `.debug` 后缀，允许与 release 版本同时安装在设备上。这对于测试和比较不同版本很有用。

Debug 版本启用了所有调试功能，包括详细的网络日志、性能监控、内存泄漏检测等。这些功能帮助开发者快速定位和解决问题。

**Release 构建**

Release 构建用于生产环境，经过完全优化：

```bash
./gradlew assembleRelease
```

Release 版本启用了代码混淆（ProGuard/R8），减小了 APK 大小并提高了安全性。混淆配置在 `proguard-rules.pro` 文件中定义。

Release 版本移除了所有调试代码和日志输出，优化了性能和电池使用。

### 构建优化

**Gradle 配置优化**

项目配置了多项 Gradle 优化来提高构建速度：

启用了 Gradle 守护进程和并行构建，充分利用多核 CPU 的性能。

配置了增量编译和构建缓存，避免重复编译未修改的代码。

使用了依赖缓存，减少网络下载时间。

**构建变体管理**

项目定义了多个构建变体来满足不同的需求：

`debug`: 开发和测试使用，包含完整的调试功能。

`release`: 生产发布使用，经过完全优化。

每个构建变体都有独立的配置，包括应用 ID、版本名称、签名配置等。

## 签名配置

### 密钥生成

**创建签名密钥**

为了发布到应用商店或进行正式分发，需要创建数字签名密钥：

```bash
keytool -genkey -v -keystore release-key.keystore -alias release -keyalg RSA -keysize 2048 -validity 10000
```

这个命令会创建一个有效期为 10000 天的 RSA 密钥。密钥信息包括组织名称、地理位置等，这些信息会包含在签名中。

**密钥安全管理**

签名密钥是应用身份的重要组成部分，必须妥善保管：

将密钥库文件存储在安全的位置，并创建多个备份。

使用强密码保护密钥库和密钥。

限制密钥的访问权限，只有授权人员才能使用。

定期检查密钥的有效性和安全性。

### 自动签名配置

**GitHub Actions 签名**

在 CI/CD 流程中，签名密钥通过 GitHub Secrets 安全传递：

密钥库文件经过 Base64 编码后存储在 GitHub Secrets 中。

构建时，工作流会解码密钥库文件并用于签名。

签名完成后，临时密钥库文件会被自动删除，确保安全性。

**本地签名配置**

开发者也可以在本地配置签名，用于测试签名版本：

在项目根目录创建 `keystore.properties` 文件（已在 .gitignore 中排除）。

在文件中配置密钥库路径、密码等信息。

Gradle 构建脚本会自动读取这些配置进行签名。

## 发布流程

### 版本发布准备

**代码准备**

在创建新版本之前，需要完成以下准备工作：

确保所有计划的功能都已完成并通过测试。

更新版本号在 `app/build.gradle` 文件中。

更新 `CHANGELOG.md` 文件，记录新版本的变更内容。

确保所有文档都是最新的，包括 README、用户手册等。

**质量检查**

发布前必须通过完整的质量检查：

运行所有自动化测试，确保功能正确性。

进行手动测试，验证关键功能和用户体验。

检查代码质量报告，确保没有严重的问题。

进行安全扫描，确保没有已知的安全漏洞。

### 自动发布流程

**标签创建**

发布流程通过创建 Git 标签触发：

```bash
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0
```

标签名必须以 'v' 开头，后跟语义化版本号。标签消息应该简要描述这个版本的主要特性。

**自动构建和发布**

标签推送后，GitHub Actions 会自动执行发布流程：

检出代码并设置构建环境。

运行完整的测试套件，确保代码质量。

构建签名的 release APK。

生成版本说明，包括功能列表和系统要求。

创建 GitHub Release，上传 APK 文件。

发送通知给相关人员，告知新版本发布。

### 发布后处理

**版本验证**

发布完成后，需要验证发布的正确性：

下载发布的 APK 文件，验证签名和功能。

检查 GitHub Release 页面的信息是否正确。

测试自动更新机制（如果实现）。

**用户通知**

通过多种渠道通知用户新版本的发布：

更新项目 README 文件，突出新版本的特性。

在社交媒体和开发者社区发布更新公告。

回复用户的问题和反馈，介绍新版本的改进。

## 质量保证

### 自动化测试

**测试策略**

项目实施多层次的自动化测试策略：

单元测试覆盖核心业务逻辑，确保各个组件的功能正确性。

集成测试验证组件间的交互，特别是网络通信和音频处理。

UI 测试自动化验证用户界面的功能和交互流程。

性能测试监控应用的资源使用和响应时间。

**测试执行**

所有测试都集成到 CI/CD 流程中：

每次代码提交都会触发快速测试套件。

每日构建会运行完整的测试套件。

发布前会执行全面的回归测试。

### 代码质量监控

**静态分析**

项目使用多种静态分析工具：

Android Lint 检查 Android 特定的问题和最佳实践。

Detekt 进行 Kotlin 代码的静态分析。

SonarQube（可选）提供全面的代码质量分析。

**质量指标**

项目跟踪多个质量指标：

代码覆盖率：目标是单元测试覆盖率达到 80% 以上。

代码复杂度：监控圈复杂度，保持在合理范围内。

技术债务：定期评估和偿还技术债务。

安全漏洞：零容忍已知的安全漏洞。

## 监控和维护

### 发布后监控

**性能监控**

虽然这是一个开源项目，但仍然需要关注应用的性能表现：

监控 GitHub Issues 中的性能相关问题报告。

收集用户反馈，了解在不同设备上的表现。

定期进行性能基准测试，确保性能不会退化。

**错误跟踪**

建立错误跟踪和处理机制：

鼓励用户通过 GitHub Issues 报告问题。

建立问题分类和优先级处理流程。

定期分析常见问题，制定预防措施。

### 维护策略

**定期更新**

制定定期维护计划：

每月检查依赖库的更新，及时升级到安全版本。

每季度进行代码重构，改善代码质量。

每年进行架构评估，考虑重大改进。

**社区管理**

作为开源项目，需要积极管理开发者社区：

及时回复 Issues 和 Pull Requests。

维护详细的贡献指南和开发文档。

组织定期的社区活动，如代码审查会议。

认可和奖励活跃的贡献者。

通过这个全面的部署指南，开发团队可以建立起可靠、高效的 CI/CD 流程，确保 LAN Music Sync 项目的持续健康发展。

